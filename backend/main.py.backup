import os
import logging
from fastapi import FastAPI, UploadFile, File, HTTPException, Form
from fastapi.responses import StreamingResponse
from fastapi.middleware.cors import CORSMiddleware
from typing import List
from pydantic import BaseModel
import io

from db_manager import DBManager
from llm_engine import LLMEngine
from design_engine import AdvancedDesignEngine
from ingestion_engine import UniversalLoader

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="Universal RAG-to-PPT API")

# CORS Configuration
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # Next.js frontend
    allow_credentials=True,
    allow_methods="*",
    allow_headers="*",
)

# Initialize engines
db_manager = DBManager()
llm_engine = LLMEngine()
design_engine = AdvancedDesignEngine()
loader = UniversalLoader()

# Pydantic Models
class GenerateRequest(BaseModel):
    topic: str

class IngestResponse(BaseModel):
    messages: List[str]

class GenerateResponse(BaseModel):
    slides_data: list
    context: str

class CreatePPTRequest(BaseModel):
    slides_data: list

class GreetingRequest(BaseModel):
    pass

class GreetingResponse(BaseModel):
    greeting: str

# Helper class to adapt FastAPI UploadFile to work with UniversalLoader
class FileAdapter:
    def __init__(self, upload_file: UploadFile):
        self.name = upload_file.filename
        self._content = None
        self._upload_file = upload_file
    
    def getbuffer(self):
        if self._content is None:
            self._content = self._upload_file.file.read()
            self._upload_file.file.seek(0)  # Reset for potential reuse
        return self._content

@app.get("/")
async def root():
    return {"message": "Universal RAG-to-PPT API is running"}

@app.get("/health")
async def health():
    return {"status": "healthy"}

@app.post("/api/ingest", response_model=IngestResponse)
async def ingest_files(files: List[UploadFile] = File(...)):
    """
    Upload and ingest files into the knowledge base.
    """
    try:
        logger.info(f"Received {len(files)} files for ingestion")
        
        # Adapt FastAPI UploadFile to work with our UniversalLoader
        adapted_files = [FileAdapter(f) for f in files]
        
        messages = db_manager.add_to_knowledge_base(adapted_files)
        
        return IngestResponse(messages=messages)
    
    except Exception as e:
        logger.error(f"Ingestion error: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/generate")
async def generate_presentation(request: GenerateRequest):
    """
    Generate presentation structure based on topic.
    """
    try:
        topic = request.topic
        
        if not topic:
            raise HTTPException(status_code=400, detail="Topic is required")
        
        logger.info(f"Generating presentation for topic: {topic}")
        
        # Retrieve context
        retriever = db_manager.get_retriever()
        docs = retriever.invoke(topic)
        context = "\n\n".join([d.page_content for d in docs])
        
        # Generate structure
        slides_data = llm_engine.generate_presentation_structure(topic, context)
        
        if not slides_data:
            raise HTTPException(status_code=500, detail="Failed to generate presentation structure")
        
        return GenerateResponse(slides_data=slides_data, context=context)
    
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Generation error: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/create-ppt")
async def create_ppt(request: CreatePPTRequest):
    """
    Create a PowerPoint file from slides data.
    """
    try:
        slides_data = request.slides_data
        logger.info(f"Creating PPT with {len(slides_data)} slides")
        logger.info(f"Slides data: {slides_data}")
        
        if not slides_data or len(slides_data) == 0:
            raise HTTPException(status_code=400, detail="No slides data provided")
        
        ppt_file = design_engine.create_presentation(slides_data)
        
        return StreamingResponse(
            ppt_file,
            media_type="application/vnd.openxmlformats-officedocument.presentationml.presentation",
            headers={"Content-Disposition": "attachment; filename=presentation.pptx"}
        )
    
    except HTTPException:
        raise
    except Exception as e:
        import traceback
        logger.error(f"PPT creation error: {e}")
        logger.error(f"Traceback: {traceback.format_exc()}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/greeting")
async def get_greeting(request: GreetingRequest):
    try:
        return GreetingResponse(greeting=design_engine.greeting())
    except Exception as e:
        logger.error(f"Greeting error: {e}")
        raise HTTPException(status_code=500, detail=str(e))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
